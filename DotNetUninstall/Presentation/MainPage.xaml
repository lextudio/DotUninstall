<Page
  x:Class="DotNetUninstall.Presentation.MainPage"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:conv="using:DotNetUninstall.Presentation.Converters"
  xmlns:sys="using:System"
  x:Name="RootPage"
  Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
  <Page.Resources>
    <conv:NullToVisibilityConverter x:Key="NullToVisibilityConverter" />
    <conv:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
    <conv:BoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter" Invert="True" />
    <conv:StringEqualsToVisibilityConverter x:Key="StringEqualsToVisibilityConverter" />
    <conv:LifecycleStateToBrushConverter x:Key="LifecycleStateToBrushConverter" />
    <conv:ChannelDisplayConverter x:Key="ChannelDisplayConverter" />
    <DataTemplate x:Key="HeaderTemplate">
      <StackPanel
        Margin="8,0,8,12"
        Padding="0"
        CornerRadius="6">
        <ToggleButton x:Name="GroupToggle" Padding="0" HorizontalAlignment="Stretch" Background="Transparent" BorderThickness="0" IsChecked="True">
          <StackPanel VerticalAlignment="Center" Orientation="Horizontal" Spacing="8">
            <TextBlock FontSize="14" FontWeight="Bold" Text=".NET" />
            <TextBlock FontSize="14" FontWeight="Bold" Text="{Binding Channel, Converter={StaticResource ChannelDisplayConverter}}" />
          </StackPanel>
        </ToggleButton>
        <Grid Margin="4,4,4,0" Visibility="{Binding IsChecked, ElementName=GroupToggle, Converter={StaticResource BoolToVisibilityConverter}}">
          <StackPanel>
            <!-- Badge row: ReleaseType | SupportPhase | EOL | latest -->
            <StackPanel Margin="6,6,0,4" Orientation="Horizontal" Spacing="6">
              <!-- Release Type badge -->
              <Border Padding="6,2" CornerRadius="4" Background="#0E5A8A" Visibility="{Binding ReleaseType, Converter={StaticResource NullToVisibilityConverter}}">
                <TextBlock FontSize="11" Foreground="White" FontWeight="SemiBold" Text="{Binding ReleaseType}" />
              </Border>
              <!-- Support Phase badge -->
              <Border Padding="6,2" CornerRadius="4" Background="#556270" Visibility="{Binding SupportPhase, Converter={StaticResource NullToVisibilityConverter}}">
                <TextBlock FontSize="11" Foreground="White" Text="{Binding SupportPhase}" />
              </Border>
              <!-- EOL badge -->
              <Border Padding="6,2" CornerRadius="4" Background="#8A2D3C" Visibility="{Binding EolBadge, Converter={StaticResource NullToVisibilityConverter}}" ToolTipService.ToolTip="{Binding EolDisplay}">
                <TextBlock FontSize="11" Foreground="White" FontWeight="SemiBold" Text="{Binding EolBadge}" />
              </Border>
              <!-- Latest version badge (show even if installed? only if missing per requirement) -->
              <Border Padding="6,2" CornerRadius="4" Background="#1F6F50" Visibility="{Binding ShowLatestRelevantMissing, Converter={StaticResource BoolToVisibilityConverter}}">
                  <TextBlock FontSize="11" Foreground="White" Text="{Binding LatestRelevantLabel}" />
              </Border>
              <Button Padding="4,0" Content="Learn more" Tag="{Binding ChannelDownloadUrl}" Click="OnOpenChannelDownload" Visibility="{Binding ShowLatestRelevantMissing, Converter={StaticResource BoolToVisibilityConverter}}" />
            </StackPanel>
            <ListView ItemTemplate="{StaticResource InstallEntryTemplate}" ItemsSource="{Binding Items}" SelectionMode="None" />
          </StackPanel>
        </Grid>
      </StackPanel>
    </DataTemplate>
    <DataTemplate x:Key="InstallEntryTemplate">
      <Grid
        MinHeight="48"
        Padding="4"
        ColumnDefinitions="*,Auto"
        ToolTipService.ToolTip="{Binding Reason}">
        <StackPanel
          Margin="4"
          Orientation="Vertical"
          Spacing="4">
          <StackPanel
            VerticalAlignment="Center"
            Orientation="Horizontal"
            Spacing="6">
            <TextBlock FontWeight="SemiBold" Text="{Binding Version}" />
            <TextBlock
              MaxWidth="360"
              FontSize="11"
              Opacity="0.65"
              Text="{Binding DisplayName}"
              TextTrimming="CharacterEllipsis" />
          </StackPanel>
          <StackPanel
            VerticalAlignment="Center"
            Orientation="Horizontal"
            Spacing="4">
            <!--  Release type (LTS/STS)  -->
            <Border
              Padding="4,2"
              Background="#0E5A8A"
              CornerRadius="4"
              Visibility="{Binding ReleaseType, Converter={StaticResource NullToVisibilityConverter}}">
              <TextBlock
                FontSize="11"
                Foreground="White"
                Text="{Binding ReleaseType}" />
            </Border>
            <!--  Preview kind badges  -->
            <Border
              Padding="4,2"
              Background="#75507B"
              CornerRadius="4"
              Visibility="{Binding PreviewKind, Converter={StaticResource StringEqualsToVisibilityConverter}, ConverterParameter=preview}">
              <StackPanel Orientation="Horizontal" Spacing="2">
                <TextBlock
                  FontSize="11"
                  Foreground="White"
                  Text="Preview" />
                <TextBlock
                  FontSize="11"
                  Foreground="White"
                  Text="{Binding PreviewNumber}"
                  Visibility="{Binding PreviewNumber, Converter={StaticResource NullToVisibilityConverter}}" />
              </StackPanel>
            </Border>
            <Border
              Padding="4,2"
              Background="#5C3566"
              CornerRadius="4"
              Visibility="{Binding PreviewKind, Converter={StaticResource StringEqualsToVisibilityConverter}, ConverterParameter=rc}">
              <StackPanel Orientation="Horizontal" Spacing="2">
                <TextBlock
                  FontSize="11"
                  Foreground="White"
                  Text="RC" />
                <TextBlock
                  FontSize="11"
                  Foreground="White"
                  Text="{Binding PreviewNumber}"
                  Visibility="{Binding PreviewNumber, Converter={StaticResource NullToVisibilityConverter}}" />
              </StackPanel>
            </Border>
            <!--  Security update  -->
            <Border
              Padding="4,2"
              Background="#8A2D3C"
              CornerRadius="4"
              Visibility="{Binding IsSecurityUpdate, Converter={StaticResource BoolToVisibilityConverter}}">
              <TextBlock
                FontSize="11"
                Foreground="White"
                Text="Security" />
            </Border>
            <!--  Out of support  -->
            <Border
              Padding="4,2"
              Background="#C0392B"
              CornerRadius="4"
              Visibility="{Binding IsOutOfSupport, Converter={StaticResource BoolToVisibilityConverter}}">
              <TextBlock
                FontSize="11"
                Foreground="White"
                Text="EOL" />
            </Border>
            <Border
              Padding="4,2"
              VerticalAlignment="Center"
              Background="#334D5C"
              CornerRadius="4">
              <TextBlock
                FontSize="11"
                Foreground="White"
                Text="{Binding Architecture}" />
            </Border>
            <Border
              Padding="4,2"
              VerticalAlignment="Center"
              Background="#3B3F58"
              CornerRadius="4"
              Visibility="{Binding SubType, Converter={StaticResource NullToVisibilityConverter}}">
              <TextBlock
                FontSize="11"
                Foreground="White"
                Text="{Binding SubType}" />
            </Border>
            <Border
              Padding="4,2"
              VerticalAlignment="Center"
              Background="#556270"
              CornerRadius="4"
              Visibility="{Binding Reason, Converter={StaticResource NullToVisibilityConverter}}">
              <TextBlock
                MaxWidth="260"
                FontSize="11"
                Foreground="White"
                Text="{Binding Reason}"
                TextTrimming="CharacterEllipsis" />
            </Border>
            <Border
              Padding="4,2"
              VerticalAlignment="Center"
              Background="#1F6F50"
              CornerRadius="4"
              Visibility="{Binding CanUninstall, Converter={StaticResource BoolToVisibilityConverter}}">
              <TextBlock
                FontSize="11"
                Foreground="White"
                Text="Removable" />
            </Border>
          </StackPanel>
        </StackPanel>
        <Button
          Grid.Column="1"
          Margin="4"
          Command="{Binding ElementName=RootPage, Path=DataContext.UninstallCommand}"
          CommandParameter="{Binding}"
          Content="Uninstall"
          IsEnabled="{Binding CanUninstall}"
          Loaded="Button_Loaded" />
      </Grid>
    </DataTemplate>
  </Page.Resources>
  <Grid RowDefinitions="Auto,*,Auto">
    <!--  Update available banner  -->
    <Border
      Grid.Row="0"
      Margin="8,8,8,4"
      Padding="12"
      Background="#D1F0D1"
      BorderBrush="#7BC47B"
      BorderThickness="1"
      CornerRadius="6"
      Visibility="{Binding HasUpdate, Converter={StaticResource BoolToVisibilityConverter}}">
      <StackPanel
        VerticalAlignment="Center"
        Orientation="Horizontal"
        Spacing="12">
        <TextBlock
          MaxWidth="640"
          FontSize="12"
          Foreground="#0B3D0B"
          TextWrapping="WrapWholeWords">
          <Run Text="Update available: " />
          <Run Text="{Binding UpdateMessage}" />
        </TextBlock>
        <Button
          Padding="8,4"
          Click="OnOpenReleasePage"
          Content="Open Release Page" />
      </StackPanel>
    </Border>
    <!--  Elevation / sudo warning banner (macOS)  -->
    <Border
      Grid.Row="0"
      Margin="8,8,8,4"
      Padding="12"
      Background="#FFF3CD"
      BorderBrush="#F8D486"
      BorderThickness="1"
      CornerRadius="6"
      Visibility="{Binding ShowElevationWarning, Converter={StaticResource BoolToVisibilityConverter}}">
      <StackPanel
        VerticalAlignment="Center"
        Orientation="Horizontal"
        Spacing="12">
        <TextBlock
          MaxWidth="640"
          FontSize="12"
          Foreground="#664D03"
          TextWrapping="WrapWholeWords">
          <Run Text="Running with elevated privileges (root). " />
          <Run Text="Original user: " />
          <Run Text="{Binding OriginalUser}" />
          <Run Text=". Uninstalls may affect the entire system. Proceed with caution." />
        </TextBlock>
        <Button
          Padding="8,4"
          VerticalAlignment="Center"
          Command="{Binding DismissElevationWarningCommand}"
          Content="Dismiss" />
      </StackPanel>
    </Border>
    <!--  Non-elevated offer banner (macOS)  -->
    <Border
      Grid.Row="0"
      Margin="8,8,8,4"
      Padding="12"
      Background="#E8F4FF"
      BorderBrush="#B3DAF7"
      BorderThickness="1"
      CornerRadius="6"
      Visibility="{Binding ShowElevationOffer, Converter={StaticResource BoolToVisibilityConverter}}">
      <StackPanel
        VerticalAlignment="Center"
        Orientation="Horizontal"
        Spacing="12">
        <TextBlock
          MaxWidth="640"
          FontSize="12"
          Foreground="#0A466E"
          TextWrapping="WrapWholeWords">
          <Run Text="Some uninstall operations may require administrator rights. " />
          <Run Text="You can relaunch this app with elevated privileges." />
        </TextBlock>
        <StackPanel
          VerticalAlignment="Center"
          Orientation="Horizontal"
          Spacing="8">
          <Button
            Padding="10,4"
            Command="{Binding ElevateCommand}"
            Content="Relaunch as Administrator" />
          <Button
            Padding="8,4"
            Command="{Binding DismissElevationOfferCommand}"
            Content="Dismiss" />
        </StackPanel>
      </StackPanel>
    </Border>
    <Pivot x:Name="MainPivot" Grid.Row="1">
      <PivotItem Header="Runtimes">
        <ScrollViewer>
          <StackPanel>
            <TextBlock
              Margin="12,0,12,8"
              FontSize="12"
              Opacity="0.7"><Run Text="Count: " /><Run Text="{Binding RuntimeCount}" /></TextBlock>
            <ItemsControl ItemTemplate="{StaticResource HeaderTemplate}" ItemsSource="{Binding GroupedRuntimeItems}" />
          </StackPanel>
        </ScrollViewer>
      </PivotItem>
      <PivotItem Header="SDKs">
        <ScrollViewer>
          <StackPanel>
            <TextBlock
              Margin="12,0,12,8"
              FontSize="12"
              Opacity="0.7"><Run Text="Count: " /><Run Text="{Binding SdkCount}" /></TextBlock>
            <ItemsControl ItemTemplate="{StaticResource HeaderTemplate}" ItemsSource="{Binding GroupedSdkItems}" />
          </StackPanel>
        </ScrollViewer>
      </PivotItem>
      <PivotItem Header="Settings">
        <ScrollViewer>
          <StackPanel Padding="12" Spacing="16">
            <TextBlock
              FontSize="14"
              FontWeight="Bold"
              Text="Application" />
            <StackPanel
              VerticalAlignment="Center"
              Orientation="Horizontal"
              Spacing="8">
              <TextBlock FontWeight="SemiBold" Text="Version:" />
              <TextBlock Text="{Binding AppVersion}" />
            </StackPanel>
            <Button
              Padding="12,6"
              Command="{Binding CheckUpdateNowCommand}"
              Content="Check for Updates Now" />
            <TextBlock
              FontSize="12"
              Text="{Binding UpdateMessage}"
              TextWrapping="WrapWholeWords" />
            <TextBlock
              FontSize="12"
              Opacity="0.6"
              Text="Manual check bypasses the once-per-day automatic delay." />
          </StackPanel>
        </ScrollViewer>
      </PivotItem>
    </Pivot>
  </Grid>
</Page>
