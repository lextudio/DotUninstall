<Page
  x:Class="DotNetUninstall.Presentation.MainPage"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:conv="using:DotNetUninstall.Presentation.Converters"
  xmlns:sys="using:System"
  x:Name="RootPage"
  Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
  <Page.Resources>
    <conv:NullToVisibilityConverter x:Key="NullToVisibilityConverter" />
    <conv:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
    <conv:BoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter" Invert="True" />
    <conv:StringEqualsToVisibilityConverter x:Key="StringEqualsToVisibilityConverter" />
    <conv:LifecycleStateToBrushConverter x:Key="LifecycleStateToBrushConverter" />
  <conv:ChannelDisplayConverter x:Key="ChannelDisplayConverter" />
    <DataTemplate x:Key="HeaderTemplate">
      <StackPanel Margin="8,0,8,12" Padding="0" CornerRadius="6">
        <ToggleButton x:Name="GroupToggle" IsChecked="True" HorizontalAlignment="Stretch" Background="Transparent" BorderThickness="0" Padding="0">
          <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
            <TextBlock Text=".NET" FontWeight="Bold" FontSize="14"/>
            <TextBlock Text="{Binding Channel, Converter={StaticResource ChannelDisplayConverter}}" FontWeight="Bold" FontSize="14"/>
          </StackPanel>
        </ToggleButton>
        <Grid Margin="4,4,4,0" Visibility="{Binding IsChecked, ElementName=GroupToggle, Converter={StaticResource BoolToVisibilityConverter}}">
          <ListView ItemsSource="{Binding Items}" ItemTemplate="{StaticResource InstallEntryTemplate}" SelectionMode="None"/>
        </Grid>
      </StackPanel>
    </DataTemplate>
    <DataTemplate x:Key="InstallEntryTemplate">
      <Grid
        MinHeight="48"
        Padding="4"
        ColumnDefinitions="*,Auto"
        ToolTipService.ToolTip="{Binding Reason}">
        <StackPanel
          Margin="4"
          Orientation="Vertical"
          Spacing="4">
          <StackPanel
            VerticalAlignment="Center"
            Orientation="Horizontal"
            Spacing="6">
            <TextBlock FontWeight="SemiBold" Text="{Binding Version}" />
          </StackPanel>
          <StackPanel
            VerticalAlignment="Center"
            Orientation="Horizontal"
            Spacing="4">
            <!--  Release type (LTS/STS)  -->
            <Border
              Padding="4,2"
              Background="#0E5A8A"
              CornerRadius="4"
              Visibility="{Binding ReleaseType, Converter={StaticResource NullToVisibilityConverter}}">
              <TextBlock
                FontSize="11"
                Foreground="White"
                Text="{Binding ReleaseType}" />
            </Border>
            <!--  Preview kind badges  -->
            <Border Padding="4,2" Background="#75507B" CornerRadius="4"
                    Visibility="{Binding PreviewKind, Converter={StaticResource StringEqualsToVisibilityConverter}, ConverterParameter=preview}">
              <StackPanel Orientation="Horizontal" Spacing="2">
                <TextBlock FontSize="11" Foreground="White" Text="Preview"/>
                <TextBlock FontSize="11" Foreground="White" Text="{Binding PreviewNumber}" Visibility="{Binding PreviewNumber, Converter={StaticResource NullToVisibilityConverter}}"/>
              </StackPanel>
            </Border>
            <Border Padding="4,2" Background="#5C3566" CornerRadius="4"
                    Visibility="{Binding PreviewKind, Converter={StaticResource StringEqualsToVisibilityConverter}, ConverterParameter=rc}">
              <StackPanel Orientation="Horizontal" Spacing="2">
                <TextBlock FontSize="11" Foreground="White" Text="RC"/>
                <TextBlock FontSize="11" Foreground="White" Text="{Binding PreviewNumber}" Visibility="{Binding PreviewNumber, Converter={StaticResource NullToVisibilityConverter}}"/>
              </StackPanel>
            </Border>
            <!--  Security update  -->
            <Border
              Padding="4,2"
              Background="#8A2D3C"
              CornerRadius="4"
              Visibility="{Binding IsSecurityUpdate, Converter={StaticResource BoolToVisibilityConverter}}">
              <TextBlock
                FontSize="11"
                Foreground="White"
                Text="Security" />
            </Border>
            <!--  Out of support  -->
            <Border
              Padding="4,2"
              Background="#C0392B"
              CornerRadius="4"
              Visibility="{Binding IsOutOfSupport, Converter={StaticResource BoolToVisibilityConverter}}">
              <TextBlock
                FontSize="11"
                Foreground="White"
                Text="EOL" />
            </Border>
            <Border
              Padding="4,2"
              VerticalAlignment="Center"
              Background="#334D5C"
              CornerRadius="4">
              <TextBlock
                FontSize="11"
                Foreground="White"
                Text="{Binding Architecture}" />
            </Border>
            <Border
              Padding="4,2"
              VerticalAlignment="Center"
              Background="#556270"
              CornerRadius="4"
              Visibility="{Binding Reason, Converter={StaticResource NullToVisibilityConverter}}">
              <TextBlock
                MaxWidth="260"
                FontSize="11"
                Foreground="White"
                Text="{Binding Reason}"
                TextTrimming="CharacterEllipsis" />
            </Border>
            <Border
              Padding="4,2"
              VerticalAlignment="Center"
              Background="#1F6F50"
              CornerRadius="4"
              Visibility="{Binding CanUninstall, Converter={StaticResource BoolToVisibilityConverter}}">
              <TextBlock
                FontSize="11"
                Foreground="White"
                Text="Removable" />
            </Border>
          </StackPanel>
        </StackPanel>
        <Button
          Grid.Column="1"
          Margin="4"
          Command="{Binding ElementName=RootPage, Path=DataContext.UninstallCommand}"
          CommandParameter="{Binding}"
          Content="Uninstall"
          IsEnabled="{Binding CanUninstall}" />
      </Grid>
    </DataTemplate>
  </Page.Resources>
  <Grid RowDefinitions="Auto,*,Auto">
    <Pivot x:Name="MainPivot" Grid.Row="1">
      <PivotItem Header="Runtimes">
        <ScrollViewer>
          <StackPanel>
            <TextBlock
              Margin="12,0,12,8"
              FontSize="12"
              Opacity="0.7"><Run Text="Count: " /><Run Text="{Binding RuntimeCount}" /></TextBlock>
            <ItemsControl ItemTemplate="{StaticResource HeaderTemplate}" ItemsSource="{Binding GroupedRuntimeItems}" />
          </StackPanel>
        </ScrollViewer>
      </PivotItem>
      <PivotItem Header="SDKs">
        <ScrollViewer>
          <StackPanel>
            <TextBlock
              Margin="12,0,12,8"
              FontSize="12"
              Opacity="0.7"><Run Text="Count: " /><Run Text="{Binding SdkCount}" /></TextBlock>
            <ItemsControl ItemTemplate="{StaticResource HeaderTemplate}" ItemsSource="{Binding GroupedSdkItems}" />
          </StackPanel>
        </ScrollViewer>
      </PivotItem>
      <PivotItem Header="Settings">
        <StackPanel Padding="12" Spacing="12">
          <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
            <Button Command="{Binding RefreshCommand}" Content="Refresh" />
            <ProgressRing Width="24" Height="24" IsActive="{Binding IsLoading}" />
            <TextBlock Margin="8,0,0,0" VerticalAlignment="Center" Text="{Binding StatusMessage}" />
          </StackPanel>
          <Border Background="#22000000" CornerRadius="6" Padding="12" >
            <StackPanel Spacing="4">
              <TextBlock FontWeight="Bold" Text="Embedded uninstall logic active" />
              <TextBlock FontSize="12" Opacity="0.85" TextWrapping="WrapWholeWords">
                This application now performs discovery and uninstall operations directly without invoking the external 'dotnet-core-uninstall' CLI. A confirmation dialog will appear before removal.
              </TextBlock>
              <TextBlock FontSize="10" Opacity="0.6" TextWrapping="WrapWholeWords">
                Tip: If an uninstall fails due to permissions, relaunch this app with elevated privileges (Administrator on Windows or via sudo on macOS) and try again.
              </TextBlock>
            </StackPanel>
          </Border>
          <TextBlock Foreground="Red" Text="{Binding ErrorMessage}" TextWrapping="WrapWholeWords" />
        </StackPanel>
      </PivotItem>
    </Pivot>
    <TextBlock
      Grid.Row="2"
      Margin="12,0,12,8"
      FontSize="10"
      Opacity="0.6"
      Text="If an uninstall fails due to permissions, run manually in terminal with elevated rights." />
  </Grid>
</Page>
